## Avoiding endless recursion for IWorkflowInstanceManagement.TransactedCancel and IWorkflowInstanceManagement.TransactedTerminate

### Scope
Edge

### Version Introduced
4.7.2

### Source Analyzer Status
NotPlanned

### Change Description
Under some circumstances when using IWorkflowInstanceManagement.TransactedCancel or IWorkflowInstanceManagement.TransactedTerminate feature to Cancel or Terminate a worklow service instance, it is possible to cause that workflow instance to encounter a stack overflow due to endless recursion when trying to persist itself as part of processing the request. The problem occurs if the workflow instance is in a state where it is waiting for some other outstanding WCF request to another service to complete.

The TransactedCancel and TransactedTerminate operations create "work items" that are queued up for the workflow service instance. These "work items" are not executed as part of the processing of the TransactedCancel/TransactedTerminate request. Because the workflow service instance is busy waiting for the other outstanding WCF request to complete, the work item created remains queued. The TransactedCancel/TransactedTerminate operation completes and control is returned back to the client. When transaction associated with the TransactedCancel/TransactedTerminate operations attempts to commit, it needs to persist the workflow serivce instance state. But because there is an outstanding WCF request for the instance, we cannot persist, and an endless recursion loop occurs leading to the stack overflow.

Because TransactedCancel and TransactedTerminate only create a "work item" in memory, the fact that a transaction exists doesn't really have any effect. A rollback of the transaction does not cause the work item to be discarded.

Therefore we have introduced an AppSetting which can be added to the Web.Config/App.Config of the workflow service that tells it to ignore transactions for TransactedCancel and TransactedTerminate. This allows the transaction to commit without waiting for the workflow instance to persist.

The AppSetting for this feature is named "microsoft:WorkflowServices:IgnoreTransactionsForTransactedCancelAndTransactedTerminate". A value of "true" indicates that the transaction should be ignored, thus avoiding the stack overflow. The default value of this AppSetting is "false", so existing workflow service instances are not affected.


- [x] Quirked 
- [ ] Build-time break

### Recommended Action
If you are using AppFabric or another IWorkflowInstanceManagement client and are encountering a stack overflow in the workflow serivce instance when trying to cancel or terminate a workflow instance, you can add the following to the <appSettings> section of the web.config/app.config for the workflow service:
  
  &lt;add key="microsoft:WorkflowServices:IgnoreTransactionsForTransactedCancelAndTransactedTerminate" value="true"/&gt;
  
If you are not encountering the problem, you do not need to do this.


### Affected APIs
  * Not detectable via API analysis

### Category
[|Pick a category from BreakingChangesCategories.json|]


<!--
    https://devdiv.visualstudio.com/DevDiv/_workitems/edit/258978
-->
